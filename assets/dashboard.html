
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Finance Tracker</title>

    <!-- Bootstrap core CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="../styles/dashboard.css" rel="stylesheet">
  </head>

  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-3">
          <h1 style="color: white">Finance Tracker</h1>
        </div>
        <div class="col-md-1 col-md-offset-8">
          <button type="button" id="signOutButton" class="btn btn-md">Sign Out</button>
        </div>
      </div>
      <div class="row">
        <!-- Left -->
        <div class="col-md-4">
          <!-- Transactions -->
          <div class="widget" id="transactionsWidget">
            <div class="row">
              <h3>Transactions</h3>
            </div>
            <div class="row">
              <!-- Button trigger modal -->
              <button type="button" id="addTransactionModalButton" class="btn btn-md" data-toggle="modal" data-target="#addTransactionModal">
                Add Transaction
              </button>

              <!-- Modal -->
              <div class="modal fade" id="addTransactionModal" tabindex="-1" role="dialog" aria-labelledby="addTransactionModalLabel" style="display: none;">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <h4 class="modal-title" id="addTransactionModalLabel">Add transaction</h4>
                    </div>
                    <div class="modal-body">
                      <form>
                        <div class="form-group">
                          <label for="addTransactionInputFile">File input</label>
                          <input type="file" id="addTransactionInputFile">
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn" data-dismiss="modal">Close</button>
                      <button type="button" id="addTransactionButton" class="btn">Submit</button>
                    </div>
                  </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
              </div><!-- /.modal -->
            </div><!-- /.row -->
            <div class="row">
              <table id="transactionsList" data-click-to-select="true" class="table table-bordered" style="width: 90%">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Account</th>
                    <th>Merchant</th>
                    <th>Category</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div><!-- /.row -->
          </div><!-- /.widget -->
        </div><!-- /.col-md-4 -->

        <!-- Middle -->
        <div class="col-md-5">
          <!-- Graphs -->
          <div class="widget" id="graphWidget">
            <div class="row">
              <h3>Graphs</h3>
            </div>
            <div class="row">
              <div id="graph">
              </div>
            </div>
            <div class="row">
              <dl>
                <dt><span style="background-color:#0099ff"></span></dt>
                <dd>Total Net Worth</dd>
                <dt><span style="background-color:#00cc66"></span></dt>
                <dd>Total Assets</dd>
                <dt><span style="background-color:#ff5050"></span></dt>
                <dd>Total Liabilities</dd>
              </dl>
            </div>
            <div class="row">
              <form>
                Start Date:<input id="startDateInput" type="date">
                End Date:<input id="endDateInput" type="date">
              </form>
            </div>
          </div>
        </div>

        <!-- Right -->
        <div class="col-md-3">
          <!-- Accounts -->
          <div class="widget" id="accountsWidget">
            <div class="row">
              <h3>Accounts</h3>
            </div>
            <div class="row">
              <!-- Button trigger modal -->
              <button type="button" id="addAccountModalButton" class="btn btn-md" data-toggle="modal" data-target="#addAccountModal">
                Add Account
              </button>

              <!-- Modal -->
              <div class="modal fade" id="addAccountModal" tabindex="-1" role="dialog" aria-labelledby="addAccountModalLabel" style="display: none;">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <h4 class="modal-title" id="addAccountModalLabel">Add account</h4>
                    </div>
                    <div class="modal-body">
                      <form>
                        <div class="form-group">
                          <label for="addAccountInputFile">File input</label>
                          <input type="file" id="addAccountInputFile">
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn" data-dismiss="modal">Close</button>
                      <button type="button" id="addAccountButton" class="btn">Submit</button>
                    </div>
                  </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
              </div><!-- /.modal -->
              <!-- Button trigger modal -->
              <button type="button" id="deleteAccountModalButton" class="btn btn-md" data-toggle="modal" data-target="#deleteAccountModal">
                Delete Account
              </button>

              <!-- Modal -->
              <div class="modal fade" id="deleteAccountModal" tabindex="-1" role="dialog" aria-labelledby="deleteAccountModalLabel" style="display: none;">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <h4 class="modal-title" id="deleteAccountModalLabel">Delete account</h4>
                    </div>
                    <div class="modal-body">
                      <form>
                        <select id="deleteAccountSelect" class="form-control">
                        </select>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn" data-dismiss="modal">Close</button>
                      <button type="button" id="deleteAccountButton" class="btn">Delete</button>
                    </div>
                  </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
              </div><!-- /.modal -->
            </div><!-- /.row -->
            <div class="row">
              <table id="accountsList" data-click-to-select="true" class="table table-bordered" style="width: 90%">
                <thead>
                  <tr>
                    <th>Account Name</th>
                    <th>Visibility</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div><!-- /.row -->
          </div><!-- /.widget -->

          <!-- Monthly Budgets -->
          <div class="widget">
            <div class="row">
              <h3>Monthly Budgets</h3>
            </div>
            <div class="row">
              <form>
                <input id="budgetMonthInput" type="month">
              </form>
            </div>
            <div class="row">
              <p id="groceriesText">Groceries</p>
              <div id="groceriesProgress" class="progress"></div>
              <p id="diningText">Dining</p>
              <div id="diningProgress" class="progress"></div>
              <p id="entertainmentText">Entertainment</p>
              <div id="entertainmentProgress" class="progress"></div>
              <p id="utilitiesText">Utilities</p>
              <div id="utilitiesProgress" class="progress"></div>
              <p id="otherText">Other</p>
              <div id="otherProgress" class="progress"></div>
            </div>
          </div>
        </div><!-- /.col-md-3 -->
      </div><!-- /.row -->
    </div><!-- /.container-fluid -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="/js/dbquery.js"></script>
    <script src="/js/graph.js"></script>
    <script src="/js/papaparse.min.js"></script>
    <script>
      var userId;
      var idleTime = 0;
      var transactions = [];
      var sortTransactionsBy = 'date';
      $(document).ready(function () {
        userId = sessionStorage.getItem('_userId');
        if (!userId) location = '/';
        userId = atob(userId);
        getAccounts(userId, function (data) {
          $('#accountsList tbody').html('');
          data.sort(function (a, b) {
            if (a.name < b.name) return -1;
            if (a.name > b.name) return 1;
            return 0;
          });
          for (var i = 0; i < data.length; i++) {
            $('#accountsList tbody').append('<tr><td class="accountName" id="' + data[i].name + 'Account" style="color: ' + getRandomColor() + '">' + data[i].name + '</td><td><input class="accountCheckbox" type="checkbox" value="' + data[i].name + '" name="' + data[i].name + '"></td></tr>');
          }
          $('.accountCheckbox').change(function() {
            if (this.checked) {
              graphAccount(userId, this.value);
            } else {
              ungraphAccount(userId, this.value);
            }
          });
          $('.accountName').click(function () {
            getTransactions(userId, $(this).html(), function(data) {
              data.sort(function(a, b) {
                if (a[sortTransactionsBy] < b[sortTransactionsBy]) return -1;
                if (a[sortTransactionsBy] > b[sortTransactionsBy]) return 1;
                return 0;
              });
              transactions = data;
              $('#transactionsList tbody').html('');
              for (var i = 0; i < data.length; i++) {
                var date = new Date(data[i].date);
                var stringDate = (1900 + date.getYear()) + '/' + (date.getMonth()+1) + '/' + (date.getDate()+1);
                $('#transactionsList tbody').append('<tr><td>' + stringDate + '</td><td>' + data[i].amount + '</td><td>' + data[i].accountName + '</td><td>' + data[i].merchant + '</td><td>' + data[i].category + '</td></tr>');
              }
            });
          });
          var today = new Date();
          var past = new Date();
          past.setMonth(past.getMonth() - 3);
          $('#startDateInput').val(convertDate(past));
          $('#endDateInput').val(convertDate(today));
          $('#graphWidget input').change(function() {
            updateDateRange($('#startDateInput').val(), $('#endDateInput').val());
          });
        });
        var idleInterval = setInterval(timerIncrement, 60000);
        $(this).mousemove(function(e) {
          idleTime = 0;
        });
        $(this).keypress(function(e) {
          idleTime = 0;
        });
        function timerIncrement() {
          idleTime += 1;
          if (idleTime > 1) {
            logout(function(data) {
              location = '/';
            });
          }
        }
        setupGraph(userId);

        var today = new Date();
        $('#budgetMonthInput').val(convertDate(today).substring(0, 7));
        updateBudgets(today.getYear()+1900, today.getMonth()+1);
        $('#budgetMonthInput').change(function() {
          var date = $('#budgetMonthInput').val();
          updateBudgets(Number(date.substring(0, 4)), Number(date.substring(5, 7)));
        });
      });
      $('#deleteAccountModal').on('show.bs.modal', function () {
        getAccounts(userId, function (data) {
          $('#deleteAccountSelect').html('');
          for (var i = 0; i < data.length; i++) {
            $('#deleteAccountSelect').append('<option>' + data[i].name + '</option>');
          }
        });
      });
      $('#deleteAccountButton').click(function () {
        var accountName = $('#deleteAccountSelect').val();
        deleteAccount(userId, accountName, function (data) {
          $('#deleteAccountModal').modal('hide');
          $('#accountsList tbody').html('');
          data.sort(function (a, b) {
            if (a.name < b.name) return -1;
            if (a.name > b.name) return 1;
            return 0;
          });
          for (var i = 0; i < data.length; i++) {
            $('#accountsList tbody').append('<tr><td class="accountName" id="' + data[i].name + 'Account" style="color: ' + getRandomColor() + '">' + data[i].name + '</td><td><input class="accountCheckbox" type="checkbox" value="' + data[i].name + '" name="' + data[i].name + '"></td></tr>');
          }
          ungraphAccount(userId, accountName);
          $('.accountCheckbox').change(function() {
            if (this.checked) {
              graphAccount(userId, this.value);
            } else {
              ungraphAccount(userId, this.value);
            }
          });
          $('.accountName').click(function () {
            getTransactions(userId, $(this).html(), function(data) {
              data.sort(function(a, b) {
                if (a[sortTransactionsBy] < b[sortTransactionsBy]) return -1;
                if (a[sortTransactionsBy] > b[sortTransactionsBy]) return 1;
                return 0;
              });
              transactions = data;
              $('#transactionsList tbody').html('');
              for (var i = 0; i < data.length; i++) {
                var date = new Date(data[i].date);
                var stringDate = (1900 + date.getYear()) + '/' + (date.getMonth()+1) + '/' + (date.getDate()+1);
                $('#transactionsList tbody').append('<tr><td>' + stringDate + '</td><td>' + data[i].amount + '</td><td>' + data[i].accountName + '</td><td>' + data[i].merchant + '</td><td>' + data[i].category + '</td></tr>');
              }
            });
          });
        });
      });
      $('#addAccountButton').click(function () {
        $('#addAccountInputFile').parse({
          config: {
            header: true,
            complete: function(results, file) {
              var length = results.data.length;
              for (var i = 0; i < length; i++) {
                addAccount(userId, results.data[i].name, results.data[i].balance, function (data) {
                  if (i >= length-1) {
                    data.sort(function (a, b) {
                      if (a.name < b.name) return -1;
                      if (a.name > b.name) return 1;
                      return 0;
                    });
                    $('#addAccountModal').modal('hide');
                    $('#accountsList tbody').html('');
                    for (var j = 0; j < data.length; j++) {
                      $('#accountsList tbody').append('<tr><td class="accountName" id="' + data[j].name + 'Account" style="color: ' + getRandomColor() + '">' + data[j].name + '</td><td><input class="accountCheckbox" type="checkbox" value="' + data[j].name + '" name="' + data[j].name + '"></td></tr>');
                    }
                    $('.accountCheckbox').change(function() {
                      if (this.checked) {
                        graphAccount(userId, this.value);
                      } else {
                        ungraphAccount(userId, this.value);
                      }
                    });
                    $('.accountName').click(function () {
                      getTransactions(userId, $(this).html(), function(data) {
                        data.sort(function(a, b) {
                          if (a[sortTransactionsBy] < b[sortTransactionsBy]) return -1;
                          if (a[sortTransactionsBy] > b[sortTransactionsBy]) return 1;
                          return 0;
                        });
                        transactions = data;
                        $('#transactionsList tbody').html('');
                        for (var j = 0; j < data.length; j++) {
                          var date = new Date(data[j].date);
                          var stringDate = (1900 + date.getYear()) + '/' + (date.getMonth()+1) + '/' + (date.getDate()+1);
                          $('#transactionsList tbody').append('<tr><td>' + stringDate + '</td><td>' + data[j].amount + '</td><td>' + data[j].accountName + '</td><td>' + data[j].merchant + '</td><td>' + data[j].category + '</td></tr>');
                        }
                      });
                    });
                  }
                });
              }
            }
          },
          before: function(file, inputElem) {
            var skipObject = {
              action: 'skip',
              reason: 'File not supported'
            };
            var continueObject = {
              action: 'continue',
            };
            var textType = /text.*/;
            if (file.type.match(textType)) {
              return continueObject;
            }
            return skipObject;
          }
        });
      });
      $('#signOutButton').click(function () {
        sessionStorage.removeItem('_userId');
        logout(function(data) {
          location = '/';
        });
      });
      $('#addTransactionButton').click(function () {
        $('#addTransactionInputFile').parse({
          config: {
            header: true,
            complete: function(results, file) {
              var length = results.data.length;
              for (var i = 0; i < length; i++) {
                addTransaction(userId, results.data[i].account, results.data[i].amount, results.data[i].merchant, results.data[i].category, results.data[i].date, function (data) {
                  if (i >= length-1) {
                    $('#addTransactionModal').modal('hide');
                  }
                });
              }
            }
          },
          before: function(file, inputElem) {
            var skipObject = {
              action: 'skip',
              reason: 'File not supported'
            };
            var continueObject = {
              action: 'continue',
            };
            var textType = /text.*/;
            if (file.type.match(textType)) {
              return continueObject;
            }
            return skipObject;
          }
        });
      });
      $('#transactionsList thead tr th').click(function () {
        if ($(this).html() == 'Date') {
          sortTransactionsBy = 'date';
        } else if ($(this).html() == 'Amount') {
          sortTransactionsBy = 'amount';
        } else if ($(this).html() == 'Account') {
          sortTransactionsBy = 'account';
        } else if ($(this).html() == 'Merchant') {
          sortTransactionsBy = 'merchant';
        } else if ($(this).html() == 'Category') {
          sortTransactionsBy = 'category';
        }
        if (transactions) {
          transactions.sort(function(a, b) {
            if (a[sortTransactionsBy] < b[sortTransactionsBy]) return -1;
            if (a[sortTransactionsBy] > b[sortTransactionsBy]) return 1;
            return 0;
          });
          $('#transactionsList tbody').html('');
          for (var i = 0; i < transactions.length; i++) {
            var date = new Date(transactions[i].date);
            var stringDate = (1900 + date.getYear()) + '/' + (date.getMonth()+1) + '/' + (date.getDate()+1);
            $('#transactionsList tbody').append('<tr><td>' + stringDate + '</td><td>' + transactions[i].amount + '</td><td>' + transactions[i].accountName + '</td><td>' + transactions[i].merchant + '</td><td>' + transactions[i].category + '</td></tr>');
          }
        }
      });

      function getRandomColor() {
        var letters = '0123456789ABCDEF'.split('');
        var color = '#';
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }

      function convertDate(date) {
        var y = date.getYear() + 1900;
        var m = date.getMonth() + 1;
        var d = date.getDate();
        var result = '';
        result += y + '-';
        if (m < 10) {
          result += '0' + m + '-';
        } else {
          result += m + '-';
        }
        if (d < 10) {
          result += '0' + d;
        } else {
          result += d;
        }
        return result;
      }

      function updateBudgets(year, month) {
        getBudgets(userId, year, month, function(data) {
          var maxValue = 0;
          for (var prop in data) {
            if (data[prop].first > maxValue) maxValue = data[prop].first;
            if (data[prop].second > maxValue) maxValue = data[prop].second;
          }
          for (var prop in data) {
            $('#' + prop + 'Text').html(capitalizeFirstLetter(prop) + ' ($' + data[prop].first + '/$' + data[prop].second + ')');
            $('#' + prop + 'Progress').html('');
            if (data[prop].first < data[prop].second) {
              $('#' + prop + 'Progress').append('<div class="progress-bar progress-bar-success" style="width: ' + data[prop].first/maxValue*100 + '%">');
              $('#' + prop + 'Progress').append('<div class="progress-bar budget-bar" style="width: ' + (data[prop].second-data[prop].first)/maxValue*100 + '%; border-right: 2px solid black;">');
            } else if (data[prop].first > data[prop].second) {
              $('#' + prop + 'Progress').append('<div class="progress-bar progress-bar-danger" style="width: ' + data[prop].second/maxValue*100 + '%" style="border-right: 2px solid black;">');
              $('#' + prop + 'Progress').append('<div class="progress-bar progress-bar-danger" style="width: ' + (data[prop].first-data[prop].second)/maxValue*100 + '%; border-left: 2px solid black;">');
            } else {
              $('#' + prop + 'Progress').append('<div class="progress-bar progress-bar-warning" style="width: ' + data[prop].second/maxValue*100 + '%" style="border-right: 2px solid black;">');
            }
          }
          
          function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
          }
        });
      }
    </script>
  </body>
</html>